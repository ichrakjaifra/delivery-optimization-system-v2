<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <!-- ========== SCHÉMA INITIAL V1 ========== -->

    <!-- Création de la table deliveries -->
    <changeSet id="v1.0-1" author="votre_nom">
        <comment>Création de la table deliveries pour stocker les livraisons</comment>

        <createTable tableName="deliveries">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="address" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="latitude" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="longitude" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="weight" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="volume" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="preferred_time_slot" type="VARCHAR(20)"/>
            <column name="status" type="VARCHAR(15)">
                <constraints nullable="false"/>
            </column>
            <column name="tour_id" type="BIGINT"/>
            <column name="delivery_order" type="INTEGER"/>
        </createTable>

        <rollback>
            <dropTable tableName="deliveries"/>
        </rollback>
    </changeSet>

    <!-- Création de la table vehicles -->
    <changeSet id="v1.0-2" author="votre_nom">
        <comment>Création de la table vehicles pour stocker les véhicules de livraison</comment>

        <createTable tableName="vehicles">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="license_plate" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="type" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="max_weight" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="max_volume" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="max_deliveries" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="range" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <rollback>
            <dropTable tableName="vehicles"/>
        </rollback>
    </changeSet>

    <!-- Création de la table warehouses -->
    <changeSet id="v1.0-3" author="votre_nom">
        <comment>Création de la table warehouses pour stocker les entrepôts</comment>

        <createTable tableName="warehouses">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="latitude" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="longitude" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
            <column name="opening_hours" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <rollback>
            <dropTable tableName="warehouses"/>
        </rollback>
    </changeSet>

    <!-- Création de la table tours -->
    <changeSet id="v1.0-4" author="votre_nom">
        <comment>Création de la table tours pour stocker les tournées de livraison</comment>

        <createTable tableName="tours">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="vehicle_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_tour_vehicle"
                             referencedTableName="vehicles" referencedColumnNames="id"/>
            </column>
            <column name="warehouse_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_tour_warehouse"
                             referencedTableName="warehouses" referencedColumnNames="id"/>
            </column>
            <column name="algorithm_used" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="total_distance" type="DOUBLE">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <rollback>
            <dropTable tableName="tours"/>
        </rollback>
    </changeSet>

    <!-- Clé étrangère deliveries.tour_id -->
    <changeSet id="v1.0-5" author="votre_nom">
        <comment>Ajout de la clé étrangère entre deliveries et tours</comment>

        <addForeignKeyConstraint baseTableName="deliveries"
                                 baseColumnNames="tour_id"
                                 constraintName="fk_delivery_tour"
                                 referencedTableName="tours"
                                 referencedColumnNames="id"
                                 onDelete="SET NULL"/>

        <rollback>
            <dropForeignKeyConstraint baseTableName="deliveries" constraintName="fk_delivery_tour"/>
        </rollback>
    </changeSet>

    <!-- Index pour améliorer les performances -->
    <changeSet id="v1.0-6" author="votre_nom">
        <comment>Création d'index pour améliorer les performances des requêtes</comment>

        <createIndex tableName="deliveries" indexName="idx_deliveries_tour_id">
            <column name="tour_id"/>
        </createIndex>

        <createIndex tableName="deliveries" indexName="idx_deliveries_status">
            <column name="status"/>
        </createIndex>

        <createIndex tableName="tours" indexName="idx_tours_date">
            <column name="date"/>
        </createIndex>

        <createIndex tableName="tours" indexName="idx_tours_vehicle_id">
            <column name="vehicle_id"/>
        </createIndex>

        <rollback>
            <dropIndex tableName="deliveries" indexName="idx_deliveries_tour_id"/>
            <dropIndex tableName="deliveries" indexName="idx_deliveries_status"/>
            <dropIndex tableName="tours" indexName="idx_tours_date"/>
            <dropIndex tableName="tours" indexName="idx_tours_vehicle_id"/>
        </rollback>
    </changeSet>

</databaseChangeLog>